name: My Jobs
on:
  pull_request:
    branches:
      - main
    types: 
      - closed  # Triggers when the pull request is closed, which includes merging
jobs:
  build_and_deploy:
    runs-on: [self-hosted]
    if: github.event.pull_request.merged == true
    env:
      CONTAINER_NAME: myappAuthContainer
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v3
      - name: Build Docker Image
        run: docker build -t myapp-auth:latest -f MBS-AUTHORIZATION.API/Dockerfile .
      - name: Manage Docker Container and Build
        run: |
          CNAME=${{ env.CONTAINER_NAME }}

          # Check if the container exists
          if [ "$(docker ps -aq -f name=$CNAME)" ]; then
              if [ "$(docker ps -aq -f status=exited -f name=$CNAME)" ]; then
                  echo ":: Container $CNAME exists and is exited"
                  echo ":: Removing exited container - $CNAME"
                  docker rm $CNAME
              else
                  echo ":: Container $CNAME exists and is running"
                  echo ":: Stopping running container - $CNAME"
                  docker stop $CNAME
                  echo ":: Removing stopped container - $CNAME"
                  docker rm $CNAME
              fi
          else
              echo ":: No existing container named $CNAME"
          fi
          # Run new container
          echo ":: Running new container - $CNAME"
          docker run -d --network=MBS -p 5000:8080 --name $CNAME myapp-auth:latest
